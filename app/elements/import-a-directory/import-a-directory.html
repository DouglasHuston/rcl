<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements/cgroup-edit-form/cgroup-edit-form.html">
<link rel="import" href="../../elements/cgroup-filter/cgroup-filter.html">

<dom-module id="import-a-directory" hoodie="{{hoodie}}" >
  <style>
    :host {
      display: block;
      padding: 1em;
    }
    paper-material {
      padding: 1em;
    }
  </style>
  <template>
    <paper-material elevation="1">
      <h1>Import a directory</h1>
      <div>Select an import.io file</div>
      <paper-input type="file" on-change="handle_file_selected"></paper-input>
      <geocode-stats hidden="{{hide_geocode_stats}}"></geocode-stats>
      <cgroup-filter id="cgroup_filter" hidden="{{hide_cgroup_filter}}"></cgroup-filter>
      <cgroup-edit-form id="cgroup_edit_form" hidden="{{hide_cgroup_edit_form}}"></cgroup-edit-form>
    </paper-material>
  </template>
</dom-module>
<script>
(function() {
  Polymer({
    is: 'import-a-directory',

    properties: {
      hoodie: {
        type: Object,
        notify: true,
        reflectToAttribute: true
      },
      hide_geocode_stats: {
        type: Boolean,
        value: true,
        notify: true
      },
      hide_cgroup_edit_form: {
        type: Boolean,
        value: true,
        notify: true
      },
      hide_cgroup_filter: {
        type: Boolean,
        value: true,
        notify: true
      }
    },
    ready:function(){
    },
    attached:function(){
      this.async(function(){
        this.hoodie = document.querySelector('hoodie-accountbar').hoodie;
      });
    },
    // Gets data from selected import.io file, geocodes it if necessary, and writes it into the database.
    handle_file_selected:function(event){
      // from old URLView.js:importio_drop_target_drop
      // Get file contents here
      var file = event.target.files[0];
      var reader = new FileReader();
      var thiz = this;
      reader.addEventListener('load', function loadEnd(){
        var json = reader.result;
        var congs_obj = JSON.parse(json);
        // Determine if this import.io data source is already in a directory in the database.
        // Note that
        //  - directory objects represent remote church directory websites, and
        //  - cgroup objects represent one denomination or group like the OPC, NAPARC, etc.
        //  So this directory's congregations fall in one or more cgroups, so we need
        //    to load a <cgroup-filter> here to allow the user to select the correct cgroup.
        //  Use the importio_guid to determine this
        var importio_guid = congs_obj.data[0]._source[0];
        // Get this directory if it exists in the db
        thiz.hoodie.store.findAll(function(object){
          if (object.type === 'directory' && object.importio_guid === importio_guid){
            return true;
          }
        })
        .done(function(directories){
          if (directories.length !== 0){
            // Then display this directory's cgroups
            var directory = directories[0];
            // Find the cgroups to which this directory's congregations belong, and display them in the
            //  <cgroup-filter>
            // TODO: Start here
            thiz.hoodie.store.findAll('cgroup')
            .done(function(available_cgroups){
              this.$.cgroup_filter.available_cgroups = available_cgroups;
              // TODO: Why doesn't this get called?
              debugger;
              // Find related cgroups
              thiz.hoodie.store.findAll(function(object){
                if (object.type === 'cgroup_directory' && object.directory_id === directory._id){
                  return true;
                }
              })
              .done(function(cgroups){
                // Display related cgroups in <cgroup-filter>
                debugger;
                this.$.cgroup_filter.selected_cgroups = cgroups;
                this.hide_cgroup_filter = false;
                // TODO: Set up listener (elsewhere in the code) to handle updating the cgroup_directory
                //  docs with their new new cgroups.
              });
            });
          }else{
            // Else create this directory
            // Create the directory
            var a = document.createElement('a');
            a.href = congs_obj.data[0]._pageUrl;
            var domain_name = a.hostname;
            thiz.hoodie.store.add('directory', {
              importio_guid: importio_guid,
              url: domain_name, // url of directory's main page, approximated to domain name
              directory_type:'importio'
            })
            .done(function(directory){
              // Show form to edit cgroup information
              thiz.hide_cgroup_edit_form = false;
              // TODO: Handle adding or removing related cgroups
              // TODO: Add an element below cgroup-filter to permit adding a new cgroup 
              //  which doesn't exist.
              // TODO: Write the congregations in this directory to the database
              // TODO: Should we associate the cgroup with these congs here?
            })
            .fail(function(error){
              console.log(error);
            });
          }
        });
        //  Consider writing all the data to the database first, then geocoding after that
        // TODO: Display form to let user describe this cgroup
        // Render stats view on geocoding progress
        thiz.hide_geocode_stats = false;
        // TODO: Fire displaying next form fields here as needed
        // TODO: Get the directory's identity from the cong URLs
        // TODO: Display the form to edit the directory's name
        // TODO: Display a stats view to notify the user of the following stats:
        //  running total: X congs have been imported successfully
        //  event: All congs' data have been imported
        //  running total: X congs have been geocoded successfully
        //  event: All congs' data have been geocoded successfully
        //  event: X congs failed geocoding (offer link to view the details)
        
        // TODO: Prepare dirs, cgroups for determining whether this file's dir, cgroup is already in the database
      });
      reader.readAsText(file);
    }

  });
})();
</script>
