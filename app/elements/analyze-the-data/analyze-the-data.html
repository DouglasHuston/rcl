<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="analyze-the-data" hoodie="{{hoodie}}">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-card {
        margin: 2em 2em 0 2em;
        padding: 1em;
      }
      #question_table td, #question_table th {
        vertical-align: top;
      }
      #question_table th {
        text-align: right;
        padding-right: 1em;
      }
    </style>
    
    <paper-card heading="Presets">

      <p>
        What kind of user are you?  Choose your user type here if you'd like to narrow the 
        list of preset questions below.
      </p>
      <paper-dropdown-menu label="I am a..." id="user_type">
        <paper-menu class="dropdown-content">
          <paper-item>Church planter</paper-item>
          <paper-item>Missionary</paper-item>
          <paper-item>Denominational statistician</paper-item>
          <paper-item>Web developer</paper-item>
          <paper-item>Curious person (doesn't narrow down the list)</paper-item>
        </paper-menu>
      </paper-dropdown-menu>

      <p>
        Choose a preset question here if you like.  We'll make a graph to help answer it.
      </p>
      <paper-dropdown-menu id="question_selector" 
        label="I'd like to know..."
        selected-item="{{selected_question}}">
        <paper-menu class="dropdown-content">
          <template is="dom-repeat" items="{{questions}}">
            <paper-item item="{{item}}">{{item.question}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>
      
      <table id="question_table" hidden="{{!selected_question.item}}">
        <tr>
          <th>
            Question:
          </th>
          <td>
            <span>{{selected_question.item.question}}</span>
          </td>
        </tr>
        <tr>
          <th>
            We'll use this formula:
          </th>
          <td>
            <span>{{selected_question.item.formula}}</span>
          </td>
        </tr>
      </table>

    </paper-card>

    <paper-card heading="Graph" id="graph_container">

      <paper-dropdown-menu id="data_set"
        label="Plot this kind of data"
        selected-item="{{selected_data_set}}"
        >
        <paper-menu id="data_set_menu"
          selected="{{selected_data_set_id}}"
          attr-for-selected="id"
          class="dropdown-content">
          <paper-item id="cong_summary">Summary data from all NAPARC congregations</paper-item>
          <paper-item>All NAPARC congregations</paper-item>
          <paper-item>All NAPARC denominations</paper-item>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-dropdown-menu id="x_key"
        label="Plot this on the X axis"
        selected-item="{{selected_x_key}}"
        >
        <paper-menu id="x_key_menu"
          selected="{{selected_x_key_id}}"
          attr-for-selected="id"
          class="dropdown-content">
          <template is="dom-repeat" items="{{x_keys}}">
            <paper-item id="{{item.var_name}}" item="{{item}}">{{item.name}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-dropdown-menu id="y_key"
        label="Plot this on the Y axis"
        selected-item="{{selected_y_key}}"
        >
        <paper-menu id="y_key_menu"
          selected="{{selected_y_key_id}}"
          attr-for-selected="id"
          class="dropdown-content">
          <template is="dom-repeat" items="{{y_keys}}">
            <paper-item id="{{item.var_name}}" item="{{item}}">{{item.name}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-dropdown-menu id="graph_type"
        label="Graph type"
        selected-item="{{selected_graph_type}}"
        >
        <paper-menu 
          selected="{{selected_graph_type_id}}"
          attr-for-selected="id"
          class="dropdown-content">
          <paper-item id="scatterplot">Scatterplot</paper-item>
          <paper-item id="bar_graph">Bar graph</paper-item>
        </paper-menu>
      </paper-dropdown-menu>

      <d3-graph id="graph" 
        data="{{data}}" 
        x_key="{{selected_x_key_id}}"
        y_key="{{selected_y_key_id}}"
        graph_type="{{selected_graph_type_id}}"
        >
      </d3-graph>

    </paper-card>

    <paper-card heading="Details">
      <p>
        This will be a table showing a list of selected congregations or other data points,
        and including a few of their details which could not be shown in the graph.
      </p>
    </paper-card>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'analyze-the-data',

      properties: {
        hoodie: {
          type: Object,
          value: {},
          notify: true
        },
        selected_question: {
          type: Object,
          value: {},
          notify: true,
          observer: '_selected_question_changed'
        },
        selected_data_set: {
          type: Object,
          value: {},
          notify: true,
          observer: '_selected_data_set_changed'
        },
        selected_data_set_id: {
          type: String,
          value: '',
          notify: true
        },
        x_keys: {
          type: Array,
          value: [],
          notify: true
        },
        y_keys: {
          type: Array,
          value: [],
          notify: true
        },
        selected_x_key_id: {
          type: String,
          value: '',
          notify: true
        },
        selected_y_key_id: {
          type: String,
          value: '',
          notify: true
        },
        selected_graph_type_id: {
          type: String,
          value: '',
          notify: true
        },
        data: {
          type: Object,
          value: {},
          notify: true
        },
        questions: {
          type: Array,
          notify: true,

          /* Weighting factors below are intended to override the defaults specified under the 'factors'
           * property of this element.
           * 
           * TODO: Add 'scraper' functions to the questions below to get data from APIs, etc.
           */
          value: function(){
            var thiz = this;
            return [
              {
                question: 'What are the most popular words found in congregations\' names?',
                user_types: ['church_planter'],
                formula: 'Word vs. frequency of occurrence',
                data_set: 'cong_summary',
                x: 'frequency',
                y: 'text',
                graph: 'bar_graph',
                list: function(){

                  // Generate the list of words and frequencies
                  // Note this returns a promise! So call list().done(function(result){});
                  return thiz.hoodie.punk.findAll('congregation')
                  .then(function(congs){

                    var word_list = [];
                    var frequencies_deduplicator = [];

                    // Get the word_list including duplicates, by splitting on whitespace
                    congs.forEach(function(cong){
                      word_list = word_list.concat(cong.name.split(/\s/));
                    });

                    // Count the frequency of each word
                    word_list.forEach(function(word){
                      word = word.toLowerCase().replace(new RegExp(/[,-.& ]+/), '');
                      if (word !== ''){
                        frequencies_deduplicator[word] = frequencies_deduplicator[word] || 0;
                        // Handle strange case where word === 'keys' and its value in the
                        //  frequencies_deduplicator array is NaN
                        if (isNaN(frequencies_deduplicator[word])){
                          frequencies_deduplicator[word] = 0;
                        }
                        frequencies_deduplicator[word]++;
                      }
                    });

                    // Convert to an array of objects
                    var frequencies_keys = Object.keys(frequencies_deduplicator);
                    var frequencies_objects = frequencies_keys.map(function(freq){
                      return {
                        text:freq,
                        frequency:frequencies_deduplicator[freq]
                      };
                    });
                    // Sort
                    var frequencies_sorted = frequencies_objects.sort(function (a,b) {
                      return b.frequency - a.frequency;
                    });

                    return frequencies_sorted;

                  });
                }
              },
              {
                question: 'What are the most popular words found in congregations\' names, segmented by state?',
                user_types: ['church_planter'],
                formula: 'Word vs. frequency of occurrence',
                x: 'frequency',
                y: 'word',
                segment_by: 'state',
                graph: 'bar_graph'
              },
              {
                question: 'What are the most popular words found in congregations\' names, segmented by city?',
                user_types: ['church_planter'],
                formula: 'Word vs. frequency of occurrence',
                x: 'frequency',
                y: 'word',
                segment_by: 'city',
                graph: 'bar_graph'
              },
              {
                question: 'What are the most popular words found in congregations\' names, segmented by denomination?',
                user_types: ['church_planter'],
                formula: 'Word vs. frequency of occurrence',
                x: 'frequency',
                y: 'word',
                segment_by: 'denomination',
                graph: 'bar_graph'
              },
              {
                question: 'Which congregations\' websites need a shorter url?',
                user_types: ['web_developer'],
                formula: 'URL length vs. congregation',
                x: function(cong){ return cong.website.length; },
                y: 'name',
                graph: 'bar_graph'
              },
            ];
          }
        },
        future_questions: {
          type: Array,
          notify: true,

          /* TODO: Add 'scraper' functions to the questions below to get data from APIs, etc.
           */
          value: [
            {
              question: 'What are the most popular words found in congregations\' names, segmented by region?',
              user_types: ['church_planter'],
              formula: 'Word vs. frequency of occurrence',
              x: 'frequency',
              y: 'word',
              segment_by: 'region',
              graph: 'bar_graph'
            },
            {
              question: 'In which city should we plant a church? Considering population growth rate.',
              user_types: ['church_planter'],
              formula: 'Distance to nearest NAPARC congregation vs. population growth rate (in last 10 years)',
              x: 'population_growth_rate',
              y: 'distance_to_nearest_naparc_cong'
            },
            {
              question: 'In which city should we plant a church? Considering number of churches in the city.',
              user_types: ['church_planter'],
              formula: 'Distance to nearest NAPARC congregation vs. number of churches',
              x: 'number_of_churches',
              y: 'distance_to_nearest_naparc_cong'
            },
            {
              question: 'In which city should we plant a church? Considering number of colleges in the city.',
              user_types: ['church_planter'],
              formula: 'Distance to nearest NAPARC congregation vs. number of colleges',
              x: 'number_of_colleges',
              y: 'distance_to_nearest_naparc_cong'
            },
            {
              question: 'Which congregations should consider starting a college ministry? Some may not have sufficient gifts to start such a ministry, but could do so with help from other congregations, and they are close to (proximity < 30 miles) a large population of students.',
              user_types: ['church_planter'],
              formula: 'Proximity to center of large minority language group vs. congregation',
              x: 'congregation',
              y: 'proximity_to_language_group',
              graph: 'bar_graph'
            },
            {
              question: 'Which congregations are most/least close to violating NAPARC\'s comity agreement?',
              user_types: ['church_planter'],
              formula: 'Distance to nearest NAPARC congregation vs. population density',
              x: 'population_density',
              y: 'distance_to_nearest_naparc_cong'
            },
            {
              question: 'Which congregations\' websites don\'t use HTML5, so might need a new website?',
              user_types: ['web_developer'],
              formula: 'Not HTML5 vs. congregation',
              x: 'website_uses_html5',
              y: 'name',
              graph: 'bar_graph'
            },
            {
              question: 'Which congregations don\'t have a website?',
              user_types: ['web_developer'],
              formula: 'No website vs. congregation',
              x: function(cong){
                if (typeof cong.website !== 'undefined' && cong.website.length !== 0){
                  return false;
                }else{
                  return true;
                }
              },
              y: 'name',
              graph: 'bar_graph'
            },
            {
              question: 'Which congregations use Flash, or Flash on mobile?',
              user_types: ['web_developer'],
              formula: 'Uses Flash vs. congregation',
              x: 'website_uses_flash',
              y: 'name',
              graph: 'bar_graph',
              scraper: function(cong){
                // TODO: Search the HTML of their home page for Flash
              }
            },
            {
              question: 'Which congregations\' website language does not match the official language of their country?',
              user_types: ['web_developer', 'missionary'],
              formula: 'Minority (not official) language group vs. congregation',
              x: 'not_official_language_group_in_country',
              y: 'name',
              graph: 'bar_graph',
              scraper: function(cong){
                // TODO: Search the HTML of their home page for their language, and search geo data API
                //  for the official language of their country.
              }
            },
            {
              question: 'Which congregations\' website language does not match the dominant language of their neighborhood?',
              user_types: ['web_developer', 'missionary'],
              formula: 'Minority language group (in neighborhood) vs. congregation',
              x: 'minority_language_group_in_neighborhood',
              y: 'name',
              graph: 'bar_graph',
              scraper: function(cong){
                // TODO: Search the HTML of their home page for their language, and search geo data API
                //  for the dominant language of their neighborhood.
              }
            },
            {
              question: 'Which congregations\' website language does not match the dominant language of their city?',
              user_types: ['web_developer', 'missionary'],
              formula: 'Minority language group (in city) vs. congregation',
              x: 'minority_language_group_in_city',
              y: 'name',
              graph: 'bar_graph',
              scraper: function(cong){
                // TODO: Search the HTML of their home page for their language, and search geo data API
                //  for the dominant language of their city.
              }
            },
            {
              // TODO: Figure out how to group by denomination
              question: 'What percent of the denomination\'s congregations speak each language, grouped by denomination?',
              user_types: ['church_planter'],
              formula: 'Percent vs. language',
              x: 'language',
              y: 'percent',
              graph: 'bar_graph',
              scraper: function(cong){
                // TODO: Search the HTML of the denomination's congregations home pages for their language, 
                //  and record cong.website_language in each cong.
                // TODO: Then write a function somewhere (maybe attach it to the cgroup) to calculate the 
                //  percent of congregations which use each language.
              }
            },
            {
              question: 'Is the denomination reaching each language group equally compared to that language group\'s size in the country?',
              user_types: ['church_planter'],
              formula: 'Language percent in denomination vs. language percent in country',
              x: 'language_percent_in_denomination',
              y: 'language_percent_in_country',
              graph: 'bar_graph',
              scraper: function(cong){
                // TODO: Search the HTML of the denomination's congregations home pages for their language, 
                //  and record cong.website_language in each cong.
                // TODO: Then write a function somewhere (maybe attach it to the cgroup) to calculate the 
                //  percent of congregations which use each language.
              }
            },
            {
              question: 'Is the denomination\'s outreach to each language group keeping up with, ahead of, or behind that language\'s growth?',
              user_types: ['church_planter'],
              formula: 'Change in language percent in denomination vs. change in language percent in country',
              x: 'language_percent_in_denomination_change',
              y: 'language_percent_in_country_change',
              scraper: function(cong){
                // TODO: Start by saving a log of changes-over-time to the languages in each cgroup
              }
            },
            {
              question: 'What percent of congregations of each language group do not have a website?',
              user_types: ['church_planter', 'web_developer', 'missionary'],
              formula: 'Language vs. percent without website',
              x: 'percent_without_website',
              y: 'language',
              graph: 'bar_graph'
            },
            {
              question: 'Which minority language group congregations are somewhat near (10 < distance < 100 miles) a large population of that language group so should consider planting a church?',
              user_types: ['church_planter'],
              formula: 'Proximity to center of large minority language group vs. congregation',
              x: 'congregation',
              y: 'proximity_to_language_group',
              graph: 'bar_graph'
            },
            {
              // TODO: Note each presbytery's denomination for the user's convenience
              question: 'How many congregations are in each presbytery?',
              user_types: ['statistician', 'church_planter', 'web_developer'],
              formula: 'Presbytery vs. congregations',
              x: 'congregations',
              y: 'presbytery',
              graph: 'bar_graph'
            },
            {
              // TODO: Note each presbytery's denomination for the user's convenience
              // TODO: We'd have to find coordinates for each presbytery's boundaries. These are
              //  available for some denominations; see the textPointsPresb values at 
              //  view-source:http://opc.org/locator.html
              question: 'Which presbyteries have the fewest congregations per square mile?',
              user_types: ['statistician', 'church_planter'],
              formula: 'Congregations in presbytery vs. square miles',
              x: 'square_miles',
              y: 'congregations',
              graph: 'bar_graph'
            },
            {
              // TODO: Note each presbytery's denomination for the user's convenience
              // TODO: We'd have to find coordinates for each presbytery's boundaries. These are
              //  available for some denominations; see the textPointsPresb values at 
              //  view-source:http://opc.org/locator.html
              question: 'Which presbyteries have the fewest congregations per capita?',
              user_types: ['statistician', 'church_planter'],
              formula: 'Congregations in presbytery vs. population',
              x: 'population',
              y: 'congregations',
              graph: 'bar_graph'
            },
          ],
        },

        /* We let users weight the relative importance of these factors in the graph
         */
        factors: {
          type: Object,
          value: {

            /* The property names below are the names used for associated values stored in
             * congregations' documents in the database.
             *
             * Each property may have a weight.
             *
             * Sub-properties below specify the default settings for each property.
             */
            distance_to_nearest_naparc_cong: {
              label: 'Distance to nearest NAPARC congregation',
              control: 'paper-dropdown-menu',
              range: [0, 500], // the default range to render in the dropdown
              min: true, // permit the user to select a minimum value
              max: true // permit the user to select a maximum value
            },
            population_density: {
              label: 'Population density',
              control: 'paper-input',
              region: 'city' // other options are neighborhood, county, state, presbytery
            },
            population_growth_rate: {
              label: 'Population growth rate',
              control: 'paper-input',
              region: 'city', // other options are neighborhood, county, state, presbytery
              period_in_years: 10 // period over which the growth rate was observed
            },

          },

          notify: true
        }
      },

      attached:function(){
        this.async(function(){

          // Initialize Hoodie
          this.hoodie = document.querySelector('hoodie-accountbar').hoodie;

        });
      },

      /* Calculate the available keys, depending on which model object is being plotted.
       */
      get_available_keys:function(){
        
        var types = [];
        types['Custom data combination'] = '';
        
        if (typeof this.selected_data_set.textContent !== 'undefined' &&
            this.selected_data_set.textContent.trim() === 'Summary data from all NAPARC congregations'){

          // Get list of all cong summary data types
          // TODO: How should we store this data so it's accessible here?  q.data_set works
          //  when q.x is not a function, but how can we handle when q.x is a function?
          this.questions.map(function(q){
            if (q.data_set === 'cong_summary'){
              types[q.x] = '';
              types[q.y] = '';
            }
          });

          // Get the list, deduplicated, with underscores replaced by spaces, and first letter capitalized
          types = Object.keys(types).map(function(type){
            var nicely_formatted_name = type.replace(new RegExp('_', 'g'), ' ')
            var nicely_formatted_name = nicely_formatted_name.charAt(0).toUpperCase() + nicely_formatted_name.slice(1);
            return {
              name: nicely_formatted_name,
              var_name: type
            };
          });

        }

        // Output to the dropdowns
        this.set('x_keys', types);
        this.set('y_keys', types);

      },

      // Handle changes to the selected_data_set
      _selected_data_set_changed:function(){
        this.get_available_keys();
      },

      // Handle changes to the selected_question
      _selected_question_changed:function(){
        var thiz = this;
        var q = this.selected_question;
        if (typeof q.item !== 'undefined'){
          q.item.list().then(function(list){
            // Set this question's data_set in the data_set dropdown
            thiz.selected_data_set_id = q.item.data_set;
            // Set this question's values in the x_keys and y_keys dropdowns
            thiz.selected_x_key_id = q.item.x;
            thiz.selected_y_key_id = q.item.y;
            // Set this question's graph type
            thiz.selected_graph_type_id = q.item.graph;
            // Write this question's list of data to the graph
            thiz.data = list;
          });
        }
      }

    });
  })();
  </script>
</dom-module>
